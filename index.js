const express = require('express');
const cors = require('cors');
require('dotenv').config();

const authRoutes = require('./routes/auth');
const pool = require('./db');

const app = express();

// Ð”Ð¾Ð·Ð²Ð¾Ð»ÑÑ”Ð¼Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚Ð¸ Ð»Ð¸ÑˆÐµ Ð· ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ñƒ Ð´Ð»Ñ Ð²Ð¸Ñ€Ð¾Ð±Ð½Ð¸Ñ‡Ð¾Ð³Ð¾ ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð°
const corsOptions = {
  origin: process.env.FRONTEND_URL, // Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ñ–Ñ‚ÑŒ Ð²Ð°Ñˆ Ð´Ð¾Ð¼ÐµÐ½ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ñƒ
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  credentials: true, // Ð¯ÐºÑ‰Ð¾ Ð²Ð¸ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚Ðµ cookies Ð°Ð±Ð¾ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–ÑŽ
};

app.use(cors(corsOptions)); // ÐÐ°Ð»Ð°ÑˆÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ CORS Ð· ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¸Ð¼Ð¸ Ð¾Ð¿Ñ†Ñ–ÑÐ¼Ð¸
app.use(express.json());

// âœ… ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ–Ð²
app.use('/api/auth', authRoutes);

// Ð¢ÐµÑÑ‚Ð¾Ð²Ð¸Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => res.send('API running'));

// ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð´Ð¾ Ð±Ð°Ð·Ð¸
pool.query('SELECT NOW()', (err, resDb) => {
  if (err) {
    console.error('âŒ Error connecting to the database:', err.stack);
  } else {
    console.log('âœ… Connected to the database at:', resDb.rows[0].now);
  }
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on http://localhost:${PORT}`);
});
